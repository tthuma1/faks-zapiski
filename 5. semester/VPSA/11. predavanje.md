- verižna replikacija - lahko nam odpove N-1 procesov
- če nam en proces vmes odpove, moramo narediti prevezave, da na novo vzpostavimo verigo - rabimo nadzorni proces (nadzorna ravnina)

### Replikacija z voditeljem

- gledamo na to, da se procesi znajo sami zmeniti, da sami med samo dobijo konsenz, kdo bo voditelj
- tudi če voditelj odpade znajo dobiti novega voditelja

Algoritmi:
- Paxos - precej kompleksen, malo luknjičasto napisana dokumentacija
- raft - bistveno bolj enostaven, v kritičnih situacijah traja malo dlje, da se stvari razrešijo; če so strežniko razpršeni po svetu, bo Paxos bolj primeren

- napake, ki jih rabimo razrešiti:
	- proces umre, komunikacija pade dol, vrstni red sporočil ni pravi

- procesi morajo zbrati voditelja in ko ga imajo, ta skrbi za zapise v shrambi
- dva končna avtomata - en za vlogo voditelja, drugi za vpisovanje v bazo
- voditelj pošilja vhodne znake v shrambe:
	- če ima shramba končno stanj, končno ukazov, ki si sledijo v pravem vrstnem redu, bodo shrambe vseh procesov eventually enake

### Raft

- čas teče v volilnih obdobjih (ang. term)
- nove volitve se začnejo zaradi težav v sistemu - nekdo ne dobiva paketov
- skrbimo za:
	- izbira voditelja
	- replikacija dnevnika
	- zagotavljanje odpornosti

Stanja končnega avtomata:
- sledilec, kandidat, voditelj
- sledilec:
	- ves čas posluša voditelja in mu sledi, dokler je glasen
	- voditelj mora periodično obveščati sledilca
	- če v času X (če časovnik poteče) ne dobi sporočila od voditelja, sproži nove volitve in postane kandidat - začne se novo volilno obdobje - proces, ki je sprožil volitve voli sam zase
	- vsak proces voli natanko enkrat
- kandidat:
	- če se volitve ne zaključijo dovolj hitro, sproži novo volilno obdobje
	- na začetku raft skonfiguriramo na liho število procesov in za zmago na volitvah rabiš večino glasov od tega začetnega števila
	- voditlj postaneš takoj, ko dobiš večino glasov

- kaj če vsi naenkrat začnejo volitve in se potem vsem naenkrat izteče časovnik:
	- rešimo tako, da nimajo vsi enakega časa časovnika
	- to je podobno kot živi objem
	- če se zgodi, da vsi naenkrat začnejo volitve, se po nekaj krogih to ne bo več zgodilo
	- kako določimo čas časovnika: začnemo z neko privzeto vrednostjo in glede na njo naredimo random +- majhna cifra

- dva tipa sporočil:
	- zahteva za volitve (voli zame, sprožanje volitev)
	- zahteva za vpis v dnevnik
- ni nepriznavanja volitev - ko dobiš sporočilo od voditelja, mu boš do konca sledil

- včasih, če je slabo (počasno) omrežje, rabi več časa, da razreši probleme, kot Paxoss

- če nič ni za vpisovati v dnevnik, voditelj pošilja srčni utrip - zahteva za vpis v dnevnik z NOP
- sledilci morajo vedeti, kdo je voditelj, zato da odjemalcu lahko povejo, na koga se mora povezati

- takoj, ko postaneš voditelj, pošlješ srčni utrip
- vsakič, ko sledilec dobi sporočilo od voditelja, se mu časovnik ponastavi na random vrednost (baseline +- random)
- voliš za tistega kandidata, od katerega si prej dobil sporočilo za začetek volitev oz. tistega, ki je v preteklosti naredil več zapisov v dnevnik

- imamo mehanizem proti izgubi sporočil:
	- ko začneš volitve, če v pričakovanem času od nekega vozlišča ne dobiš glasu, mu še enkrat pošlješ zahtevo za volitve

- če je sledilec v starem volilnem obdobju, se bo syncal v trenutno volilno obdobje tako, ko dobi prvo sporočilo od voditelja
- voditelj z vsakim sporočilom pošlje svojo številko in trenutno številko volilnega obdobja

- da raft funkcionira, nam mora delati več kot polovico procesov (lahko umre $\lfloor N/2\rfloor$ procesov)

Vpisovanje v dnevnik:
- sporočila, ki jih dobimo od odjemalcev, ne pomenijo zapisa v bazo, ampak najprej voditelj piše v dnevnik in to pošlje na vse sledilce
- šele, ko sledilci potrdijo zahtevo za zapis, bo voditelj izvedel zapis v bazi
- z naslednjo zahtevo za zapis se bo prejšnji zapis iz dnevnika v bazo zapisal tudi v sledilcih
- vse zapise v shrambo zahteva izključno voditelj
- vse zahteva za zapis v dnevnik imajo:
	- oznako voditelja
	- volilno obdobje
	- referenca na predhodno sporočilo (volilno obdobje in zaporedna številka zapisa)
	- podatki o novem zapisu (volilno obdobje in zaporedna številka zapisa)
- če je nek sledilec zgrešil nekaj sporočil, ker je bil ugasnjen, mora preveriti, ali ima prejšnji zapis - vidi da ga nima in da mora dopolniti svojo shrambo, da bo enaka kot na voditelju - potem spet normalno sprejema naslednje zahteve
- voditelj si lahko naredi seznam zahtev, ki jih mora poslati sledilcem, ampak dejansko jih pošilja eno po eno, ne več skupaj